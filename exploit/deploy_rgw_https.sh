#!/bin/bash

RGW_NODE=$(_get_fqdn_from_pillar_role rgw)



# @ MASTER:
echo "\
[client.rgw.ses5node2]
rgw_frontends = civetweb port=443s ssl_certificate=/etc/ceph/rgw.pem " >> /etc/ceph/ceph.conf
salt-cp '*' '/etc/ceph/ceph.conf' '/etc/ceph/'


[[ -d /srv/salt/ceph/rgw/cert ]] && cd /srv/salt/ceph/rgw/cert || mkdir /srv/salt/ceph/rgw/cert
openssl req -x509 -nodes -days 1095 -newkey rsa:4096 -keyout rgw.key -out rgw.crt -subj "/C=CZ/ST=Praha/L=Prague/O=SUSEQA/OU=QA/CN=qatest"
cat rgw.key > rgw.pem && cat rgw.crt >> rgw.pem

echo "\
[ client.{{ client }} ]
rgw frontends = "civetweb port=443s ssl_certificate=/etc/ceph/rgw.pem"
rgw dns name = {{ grains['host'] }}" > /srv/salt/ceph/configuration/files/ceph.conf.rgw

echo "\
include:
  - .{{ salt['pillar.get']('rgw_init', 'default') }}
  - .cert" > /srv/salt/ceph/rgw/init.sls

echo"\
deploy the rgw.pem file:
  file.managed:
    - name: /etc/ceph/rgw.pem
    - source: salt://ceph/rgw/cert/rgw.pem" > /srv/salt/ceph/rgw/cert/init.sls

salt-run state.orch ceph.stage.0	# there is error with openattic, should it be reported? 
salt-run state.orch ceph.stage.1
salt-run state.orch ceph.stage.2
salt-run state.orch ceph.stage.3
salt-run state.orch ceph.stage.4

# @ MASTER:
cp /srv/salt/ceph/rgw/cert/rgw.pem /etc/ceph/rgw.pem
salt-cp -C 'I@roles:rgw' '/etc/ceph/rgw.pem' '/etc/ceph/'

echo "\
[client.rgw.ses5node2]
rgw_frontends = civetweb port=443s ssl_certificate=/etc/ceph/rgw.pem " >> /etc/ceph/ceph.conf
salt-cp '*' '/etc/ceph/ceph.conf' '/etc/ceph/'

# check if the port is OK
salt \* cmd.run "ss -l -p -n|grep tcp|grep rados"|awk '{print $4}' # should be *:443

# curl -X GET http://ses5node2 # testing plain html
# TODO: how to test CA cert with curl?
curl -X --cacert ???/etc/ceph/rgw.pem GET https://ses5node2