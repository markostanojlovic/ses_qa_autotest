


mkdir /srv/salt/ceph/rgw/cert
cd /srv/salt/ceph/rgw/cert
openssl req -x509 -nodes -days 1095 -newkey rsa:4096 -keyout rgw.key -out rgw.crt
cat rgw.key > rgw.pem && cat rgw.crt >> rgw.pem

/srv/salt/ceph/configuration/files/ceph.conf.rgw

[ client.{{ client }} ]
rgw frontends = "civetweb port=443s ssl_certificate=/etc/ceph/rgw.pem"
rgw dns name = {{ grains['host'] }}

srv/salt/ceph/rgw/init.sls

include:
  - .{{ salt['pillar.get']('rgw_init', 'default') }}
  - .cert


echo"\
deploy the rgw.pem file:
  file.managed:
    - name: /etc/ceph/rgw.pem
    - source: salt://ceph/rgw/cert/rgw.pem" > /srv/salt/ceph/rgw/cert/init.sls

salt-run state.orch ceph.stage.0
salt-run state.orch ceph.stage.1
salt-run state.orch ceph.stage.2
salt-run state.orch ceph.stage.3
salt-run state.orch ceph.stage.4