#!/bin/bash
# Sourcing the helper functions commonly used in other scripts

function _get_salt_grain_value {
	# input argument is salt grain key
	salt -C G@${1}:* grains.item $1 --out=yaml|grep $1|sed "s/${1}: //g"|tr -d ' '
}

function _get_fqdn_from_salt_grain_key {
	# input argument is salt grain key
	salt -C G@${1}:* grains.item fqdn --out yaml|grep fqdn|sed 's/fqdn: //g'|tr -d ' '
}

function _get_fqdn_from_pillar_role {
	# input argument is salt grain key
	salt -C I@roles:${1} grains.item fqdn --out yaml|grep fqdn|sed 's/fqdn: //g'|tr -d ' '
}

function _get_salt_master_fqdn {
	echo $(salt-call grains.item master --out yaml |grep master|awk -F ':' '{print $2}'|tr -d ' ')
}

function _test_command_for_timeout {
  timeout_limit=$1
  command_to_test=$2
  timeout $timeout_limit $command_to_test
  timeout_rc=$?
  if [[ $timeout_rc == 0 ]];then
    	echo "INFO: command: [ $command_to_test ] finished OK"
    else
    	echo "ERROR: command: [ $command_to_test ] timed out after $timeout_limit seconds"; echo 'Result: NOT_OK';exit 1 
  fi
}

function _run_script_on_remote_host {
	# USAGE: _run_script_on_remote_host HOST SCRIPT_PATH SCRIPT_OTHER_ARGUMENTS
	REMOTE_HOST=$1
	SCRIPT_NAME=${2##*/}
	LOG_FILE=/tmp/${SCRIPT_NAME}.log_$(date +%Y_%m_%d_%H_%M_%S)
	scp $2 $REMOTE_HOST:/tmp/$SCRIPT_NAME
	ssh $REMOTE_HOST "chmod +x /tmp/$SCRIPT_NAME"
	shift;shift
	ssh $REMOTE_HOST "/tmp/$SCRIPT_NAME $@" > $LOG_FILE 2>&1
}

function _run_command_on_remote_host {
	# USAGE: _run_command_on_remote_host HOST "COMMAND"
	REMOTE_HOST=$1
	COMMAND=$2
	NAME_N_ARGS=${COMMAND##*/}
	SCRIPT_NAME=${NAME_N_ARGS%\.sh*}
	LOG_FILE=/tmp/${SCRIPT_NAME}.log_$(date +%Y_%m_%d_%H_%M_%S)
	ssh $REMOTE_HOST "$COMMAND" > $LOG_FILE 2>&1
}
